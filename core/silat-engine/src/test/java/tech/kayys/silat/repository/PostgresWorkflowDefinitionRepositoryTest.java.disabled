package tech.kayys.silat.repository;

import io.quarkus.test.junit.QuarkusTest;
import io.quarkus.test.InjectMock;
import io.vertx.mutiny.pgclient.PgPool;
import io.vertx.mutiny.sqlclient.Row;
import io.vertx.mutiny.sqlclient.RowSet;
import io.vertx.mutiny.sqlclient.RowIterator;
import io.vertx.mutiny.sqlclient.PreparedQuery;
import io.vertx.mutiny.sqlclient.Tuple;
import io.smallrye.mutiny.Uni;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;
import tech.kayys.silat.model.TenantId;
import tech.kayys.silat.model.WorkflowDefinition;
import tech.kayys.silat.model.WorkflowDefinitionId;
import tech.kayys.silat.model.WorkflowMetadata;
import jakarta.inject.Inject;

import java.time.Instant;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@QuarkusTest
public class PostgresWorkflowDefinitionRepositoryTest {

    @Inject
    PostgresWorkflowDefinitionRepository repository;

    @InjectMock
    PgPool pgPool;

    @SuppressWarnings("rawtypes")
    private PreparedQuery preparedQuery;

    @BeforeEach
    @SuppressWarnings("unchecked")
    void setUp() {
        preparedQuery = mock(PreparedQuery.class);
        when(pgPool.preparedQuery(anyString())).thenReturn(preparedQuery);

        RowSet<Row> emptyRowSet = mock(RowSet.class);
        RowIterator<Row> emptyIterator = mock(RowIterator.class);
        when(emptyRowSet.iterator()).thenReturn(emptyIterator);
        when(emptyIterator.hasNext()).thenReturn(false);
        when(preparedQuery.execute(any())).thenReturn(Uni.createFrom().item(emptyRowSet));
    }

    @Test
    @SuppressWarnings("unchecked")
    void testSave() {
        WorkflowDefinitionId defId = WorkflowDefinitionId.of(UUID.randomUUID().toString());
        TenantId tenantId = TenantId.of("test-tenant");
        WorkflowMetadata metadata = new WorkflowMetadata(Collections.emptyMap(), Collections.emptyMap(), Instant.now(),
                "user");

        WorkflowDefinition definition = new WorkflowDefinition(
                defId, tenantId, "test-wf", "1.0.0", "description",
                Collections.emptyList(), Collections.emptyMap(), Collections.emptyMap(),
                metadata, null, null);

        repository.save(definition, tenantId).await().indefinitely();

        verify(pgPool).preparedQuery(contains("INSERT INTO workflow_definitions"));
    }

    @Test
    @SuppressWarnings("unchecked")
    void testFindById() {
        WorkflowDefinitionId defId = WorkflowDefinitionId.of(UUID.randomUUID().toString());
        TenantId tenantId = TenantId.of("test-tenant");

        repository.findById(defId, tenantId).await().indefinitely();

        verify(pgPool).preparedQuery(contains("SELECT definition_id"));
    }
}
